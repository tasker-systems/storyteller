name: Python Tests

# =============================================================================
# Three Python packages:
#   doc-tools/                — Document extraction utilities (no tests, lint only)
#   training/                 — Character prediction training (lint + tests)
#   training/event_classifier — Event classification training (lint + tests)
#
# Training tests are self-contained — they generate synthetic JSONL fixtures
# and don't require the storyteller-data repo or a trained model.
# =============================================================================

on:
  workflow_call:

jobs:
  lint-and-test:
    name: Python Lint & Test
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      # ========================================================================
      # doc-tools: lint only (no tests exist)
      # ========================================================================
      - name: "doc-tools: ruff check"
        run: uvx ruff check .
        working-directory: doc-tools

      - name: "doc-tools: ruff format check"
        run: uvx ruff format --check .
        working-directory: doc-tools

      # ========================================================================
      # training (character prediction): lint + test
      # ========================================================================
      - name: "training: ruff check"
        run: uvx ruff check src/ tests/
        working-directory: training

      - name: "training: ruff format check"
        run: uvx ruff format --check src/ tests/
        working-directory: training

      - name: "training: install dependencies"
        run: uv sync --dev
        working-directory: training

      - name: "training: pytest"
        run: uv run python -m pytest tests/ -v
        working-directory: training

      # ========================================================================
      # training/event_classifier: lint + test
      # ========================================================================
      - name: "event_classifier: ruff check"
        run: uvx ruff check .
        working-directory: training/event_classifier

      - name: "event_classifier: ruff format check"
        run: uvx ruff format --check .
        working-directory: training/event_classifier

      - name: "event_classifier: install dependencies"
        run: uv sync --dev
        working-directory: training/event_classifier

      - name: "event_classifier: pytest"
        run: uv run python -m pytest -v
        working-directory: training/event_classifier
