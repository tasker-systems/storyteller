# =============================================================================
# Storyteller â€” Workspace-Level cargo-make Tasks
# =============================================================================
# Composite tasks that operate across the entire workspace.
# Extended by the root Makefile.toml.

extend = "./base-tasks.toml"

[tasks.check]
description = "Run all quality checks"
dependencies = ["rust-fmt-check", "rust-clippy", "rust-docs"]

[tasks.test]
description = "Run tests (unit tests, no feature flags)"
dependencies = ["test-unit"]

[tasks.fix]
description = "Auto-fix formatting and lint issues"
dependencies = ["rust-fmt-fix", "rust-clippy-fix"]

[tasks.build]
description = "Build all workspace crates"
command = "cargo"
args = ["build", "--workspace", "--all-features"]

# --- Rust Sub-Tasks ---

[tasks.rust-fmt-check]
description = "Check Rust formatting"
command = "cargo"
args = ["fmt", "--all", "--", "--check"]

[tasks.rust-fmt-fix]
description = "Fix Rust formatting"
command = "cargo"
args = ["fmt", "--all"]

[tasks.rust-clippy]
description = "Run Clippy lints"
command = "cargo"
args = ["clippy", "--all-targets", "--all-features", "--", "-D", "warnings"]

[tasks.rust-clippy-fix]
description = "Fix Clippy issues"
command = "cargo"
args = ["clippy", "--all-targets", "--all-features", "--fix", "--allow-dirty", "--allow-staged"]

[tasks.rust-test]
description = "Run all Rust tests (all feature flags)"
command = "cargo"
args = ["test", "--workspace", "--all-features"]

[tasks.rust-docs]
description = "Check documentation builds"
command = "cargo"
args = ["doc", "--workspace", "--no-deps", "--document-private-items"]

# --- Test Tiers ---

[tasks.test-unit]
description = "Run unit tests (no feature flags)"
command = "cargo"
args = ["test", "--workspace"]

[tasks.test-ml]
description = "Run tests including ML model tests (needs ONNX model on disk)"
command = "cargo"
args = ["test", "--workspace", "--features", "test-ml-model"]

[tasks.test-llm]
description = "Run all test tiers including LLM integration (needs Ollama)"
command = "cargo"
args = ["test", "--workspace", "--features", "test-ml-model,test-llm"]

[tasks.test-all]
description = "Run all test tiers"
alias = "test-llm"

# --- Python Tasks ---

[tasks.check-python]
description = "Lint all Python packages"
script = [
    "cd doc-tools && uv run ruff check .",
    "cd training && uv run ruff check src/ tests/",
    "cd training/event_classifier && uv run ruff check .",
]

[tasks.test-python]
description = "Test all Python packages"
script = [
    "cd doc-tools && uv run pytest",
    "cd training && uv run pytest tests/",
    "cd training/event_classifier && uv run pytest",
]

# --- Environment Setup ---

[tasks.setup-env]
description = "Generate .env for unit tests"
script = ["bash cargo-make/scripts/setup-env.sh --mode=test"]

[tasks.setup-env-ml]
description = "Generate .env for ML model tests"
script = ["bash cargo-make/scripts/setup-env.sh --mode=test-ml"]

[tasks.setup-env-dev]
description = "Generate .env for development"
script = ["bash cargo-make/scripts/setup-env.sh --mode=dev"]

# --- Shortcuts ---

[tasks.c]
alias = "check"
description = "Shortcut for check"

[tasks.t]
alias = "test"
description = "Shortcut for test"

[tasks.f]
alias = "fix"
description = "Shortcut for fix"

[tasks.b]
alias = "build"
description = "Shortcut for build"

[tasks.tu]
alias = "test-unit"
description = "Shortcut for test-unit"

[tasks.tm]
alias = "test-ml"
description = "Shortcut for test-ml"

[tasks.tl]
alias = "test-llm"
description = "Shortcut for test-llm"

# --- Docker Tasks ---

[tasks.docker-up]
description = "Start PostgreSQL + AGE development database"
script = ["docker compose -f docker/docker-compose.dev.yml up -d"]

[tasks.docker-down]
description = "Stop development database"
script = ["docker compose -f docker/docker-compose.dev.yml down"]

[tasks.docker-down-volumes]
description = "Stop development database and remove data volumes"
script = ["docker compose -f docker/docker-compose.dev.yml down -v"]

[tasks.docker-logs]
description = "Follow development database logs"
script = ["docker compose -f docker/docker-compose.dev.yml logs -f"]

[tasks.docker-psql]
description = "Open psql shell to development database"
script = ["docker exec -it storyteller-postgres psql -U storyteller -d storyteller_development"]
